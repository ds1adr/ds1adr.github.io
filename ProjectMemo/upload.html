<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodaysHistoryManager</title>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  </head>
  <body>
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/10.12.1/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/10.12.1/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/10.12.1/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/10.12.1/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/10.12.1/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/10.12.1/firebase-storage-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script   src="https://code.jquery.com/jquery-3.7.1.min.js"   integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="   crossorigin="anonymous"></script>

    <div class="container mt-3">
      <input type="text" class="form-control mt-2" id="title" placeholder="제목">
      <input type="number" class="form-control mt-2" id="displayYear" placeholder="게시연도">
      <input type="number" class="form-control mt-2" id="eventYear" placeholder="발생연도">
      <input type="number" class="form-control mt-2" id="month" placeholder="월">
      <input type="number" class="form-control mt-2" id="day" placeholder="일">
      <p></p>
      <p>설명</p>
      <textarea class="form-control mt-2" id="description"></textarea>
      <input type="text" class="form-control mt-2" id="youtubeLink" placeholder="Youtube Link">
      <input type="text" class="form-control mt-2" id="webLink" placeholder="Web Link">
      <input class="form-control mt-2" type="file" id="image">
      <button class="btn btn-danger mt-3" id="send">Upload</button>
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
      import { getFirestore, query, collection, doc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js";
      import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";
      import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-storage.js"
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries
    
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDzGQ9HfbpJzCU4e4BEmXcqcNR0jE4D5CY",
        authDomain: "todays-history.firebaseapp.com",
        databaseURL: "https://todays-history.firebaseio.com",
        projectId: "todays-history",
        storageBucket: "todays-history.appspot.com",
        messagingSenderId: "179077162749",
        appId: "1:179077162749:web:811f4cc8f9cd3cdd6c0094"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const openCollectionRef = collection(db, "Open");
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();
      const storage = getStorage();

      clearForm()

      function clearForm() {
        const today = new Date();
        const year = today.getFullYear();
        console.log("year: ")

        document.getElementById("title").value = '';
        document.getElementById("displayYear").value = year;
        document.getElementById("eventYear").value = '';
        document.getElementById("month").value = '';
        document.getElementById("day").value = '';
        document.getElementById("description").value = '';
        document.getElementById("youtubeLink").value = '';
        document.getElementById("webLink").value = '';
      }

      function sendDocument() {
        const year = Number($("#displayYear").val());
        const eventYear = Number($("#eventYear").val());
        const month = Number($("#month").val());
        const day = Number($("#day").val());
        const privateCollectionRef = collection(db, "Users/" + auth.currentUser.uid + "/TodayHistory")

        if (year < 2024) {
          document.getElementById("displayYear").style.borderColor='#ff0000';
        } else if (eventYear < 1) {
          document.getElementById("eventYear").style.borderColor='#ff0000';
        } else if (month < 1 || month > 12) {
          document.getElementById("month").style.borderColor='#ff0000';
        } else if (day < 1 || day > 31) {
          document.getElementById("day").style.borderColor='#ff0000';
        } else {
          var file = document.querySelector("#image").files[0];
          if (file != null) {
            var imageRef = ref(storage, "images/" + file.name);

            uploadBytes(imageRef, file).then((snapshot) => {
              getDownloadURL(imageRef).then((downloadURL) => {
                const docRef = doc(openCollectionRef)
                setDoc(docRef, {
                  uid: auth.currentUser.uid,
                  title: $("#title").val(),
                  year: year,
                  eventYear: eventYear,
                  month: Number($("#month").val()),
                  day: Number($("#day").val()),
                  description: $("#description").val(),
                  youtubeLink: $("#youtubeLink").val(),
                  webLink: $("#webLink").val(),
                  imageName: file.name,
                  imageURL: downloadURL,
                  timestamp: Date.now() / 1000,
                  likedCount: 0
                }).then(() => {
                  setDoc(doc(privateCollectionRef), {
                    openDocumentId: docRef.id,
                    title: $("#title").val(),
                    year: year,
                    eventYear: eventYear,
                    month: Number($("#month").val()),
                    day: Number($("#day").val()),
                    description: $("#description").val(),
                    youtubeLink: $("#youtubeLink").val(),
                    webLink: $("#webLink").val(),
                    imageName: file.name,
                    imageURL: downloadURL,
                    timestamp: Date.now() / 1000
                  }).then(() => {
                    clearForm();
                  });
                });
              });
            })
          } else {
            const docRef = doc(openCollectionRef)
            setDoc(docRef, {
              uid: auth.currentUser.uid,
              title: $("#title").val(),
              year: year,
              eventYear: eventYear,
              month: Number($("#month").val()),
              day: Number($("#day").val()),
              description: $("#description").val(),
              youtubeLink: $("#youtubeLink").val(),
              webLink: $("#webLink").val(),
              timestamp: Date.now() / 1000,
              likedCount: 0
            }).then(() => {
              setDoc(doc(privateCollectionRef), {
                openDocumentId: docRef.id,
                title: $("#title").val(),
                year: year,
                eventYear: eventYear,
                month: Number($("#month").val()),
                day: Number($("#day").val()),
                description: $("#description").val(),
                youtubeLink: $("#youtubeLink").val(),
                webLink: $("#webLink").val(),
                timestamp: Date.now() / 1000
              }).then(() => {
                clearForm();
              });
            });
          }
        }
      }

      $("#send").click(function() {
        if (!auth.currentUser) {
          signInWithPopup(auth, provider).then((result)=>{
            sendDocument();
          }).catch((error)=>{

          });
        } else {
          sendDocument();
        };
      });
      
    </script>
  </body>
</html>
